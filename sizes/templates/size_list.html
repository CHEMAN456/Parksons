{% extends "base_list.html" %}

{% block content %}
{{ block.super }}

<!-- Messages block -->
{% if messages %}
<div class="mb-3">
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endfor %}
</div>

{% endif %}
<!-- Refresh Button -->
{% comment %} <div class="mb-3">
    <button id="refreshTable" class="btn btn-outline-primary btn-sm">
        <i class="fas fa-sync-alt"></i> Refresh Table
    </button>
</div> {% endcomment %}
<div id="data-table"></div>
{% endblock %}

{% block scripts %}
<script>
console.log("Script starting...");

// Cache for current filter values to avoid unnecessary updates
let currentFilterValues = {};

// Fetch initial filter data, then initialize Tabulator
fetch("/api/sizes/")
    .then(res => res.json())
    .then(filterData => {
        console.log("Filter data received:", filterData);

        // Build initial filter options from backend filters
        let codeOptions   = {"": "All"};
        let nameOptions   = {"": "All"};
        let sizeLengthOptions = {"": "All"};
        let sizeWidthOptions  = {"": "All"};
        let lengthMMOptions   = {"": "All"};
        let widthMMOptions    = {"": "All"};
        let unitOptions   = {"": "All"};
        let activeOptions = {"": "All"};

        if(filterData.filters){
            if(filterData.filters.code) {
                filterData.filters.code.forEach(v => codeOptions[v] = v);
            }
            if(filterData.filters.name) {
                filterData.filters.name.forEach(v => nameOptions[v] = v);
            }
            if(filterData.filters.size_length) {
                filterData.filters.size_length.forEach(v => sizeLengthOptions[v] = v);
            }
            if(filterData.filters.size_width) {
                filterData.filters.size_width.forEach(v => sizeWidthOptions[v] = v);
            }
            if(filterData.filters.length_in_mm) {
                filterData.filters.length_in_mm.forEach(v => lengthMMOptions[v] = v);
            }
            if(filterData.filters.width_in_mm) {
                filterData.filters.width_in_mm.forEach(v => widthMMOptions[v] = v);
            }
            if(filterData.filters.unit_code) {
                filterData.filters.unit_code.forEach(v => unitOptions[v] = v);
            }
            if(filterData.filters.active) {
                filterData.filters.active.forEach(v => {
                    if(v === true) activeOptions["true"] = "Active";
                    else if(v === false) activeOptions["false"] = "Inactive";
                });
            }
        }

        // Function to update column title with filter value
        function updateColumnTitle(field, value){   
            // Only update if value changed
            if (currentFilterValues[field] === value) return;
            currentFilterValues[field] = value;
            
            console.log("updateColumnTitle called - Field:", field, "Value:", value);
            
            const column = table.getColumn(field);
            if (!column) {
                console.error("Column not found:", field);
                return;
            }
            
            const baseTitles = {
                "code": "Code",
                "name": "Name",
                "size_length": "Size Length",
                "size_width": "Size Width",
                "length_in_mm": "Length (mm)",
                "width_in_mm": "Width (mm)",
                "unit_code": "Unit",
                "active": "Active"
            };
            
            let newTitle = baseTitles[field] || field;
            
            if(value && value !== "" && value !== "All"){
                if (field === "active") {
                    const displayValue = value === "true" ? "Active" : "Inactive";
                    newTitle += ` (${displayValue})`;
                } else {
                    newTitle += ` (${value})`;
                }
            }
            
            console.log("Updating title to:", newTitle);
            column.updateDefinition({title: newTitle});
        }

        // Function to update dropdown display
        function updateFilterDisplay(field, value) {
            // Only update if value changed
            if (currentFilterValues[field] === value) return;
            
            setTimeout(() => {
                const column = table.getColumn(field);
                if (!column) return;
        
                const headerElement = column.getElement();
                const selectElement = headerElement.querySelector("select");
        
                if (selectElement) {
                    // Only update DOM if value actually changed
                    if (selectElement.value !== value) {
                        selectElement.value = value || "";
                
                        // Visual feedback
                        if (value && value !== "" && value !== "All") {
                            selectElement.style.background = "#e3f2fd";
                            selectElement.style.borderColor = "#2196f3";
                            selectElement.style.fontWeight = "bold";
                        } else {
                            selectElement.style.background = "";
                            selectElement.style.borderColor = "";
                            selectElement.style.fontWeight = "";
                        }
                    }
            
                    console.log("Updated dropdown for", field, "to value:", value);
                }
            }, 10);
        }

        // Refresh table function - SAFE VERSION
        function setupRefreshButton() {
            const refreshBtn = document.getElementById('refreshTable');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', function() {
                    console.log("Refreshing table...");

                    // Clear global search
                    const globalSearch = document.getElementById("globalSearch");
                    if (globalSearch) globalSearch.value = "";

                    // Clear filters and reload data
                    table.clearHeaderFilter();
                    table.setPage(1);

                    // Simple refresh
                    setTimeout(() => {
                        table.setData(); // Reload from /api/sizes/
                    }, 100);
                });
            } else {
                console.warn("Refresh button not found â€” retrying...");
                // Retry after short delay in case DOM is still rendering
                setTimeout(setupRefreshButton, 500);
            }
        }

        // Initialize Tabulator
        var table = new Tabulator("#data-table", {
            height: "500px",
            layout: "fitColumns",
            ajaxURL: "/api/sizes/",
            ajaxConfig: "GET",
            pagination: true,
            paginationMode: "remote",
            paginationSize: 10,
            paginationSizeSelector: [10, 25, 50, 100],
            paginationCounter: "rows",
            ajaxFiltering: true,
            ajaxSorting: true,
            filterMode: "remote",
            columns: [
                {
                    title:"Code", 
                    field:"code", 
                    headerFilter:"list", 
                    headerFilterParams:{values: codeOptions}, 
                    headerFilterFunc:"=", 
                    sorter:"number", 
                    editor:false
                },
                {
                    title:"Name", 
                    field:"name", 
                    headerFilter:"list", 
                    headerFilterParams:{values: nameOptions}, 
                    headerFilterFunc:"=", 
                    editor:"input", 
                    sorter:"string"
                },
                {
                    title:"Size Length", 
                    field:"size_length", 
                    headerFilter:"list", 
                    headerFilterParams:{values: sizeLengthOptions}, 
                    headerFilterFunc:"=", 
                    sorter:"number"
                },
                {
                    title:"Size Width", 
                    field:"size_width", 
                    headerFilter:"list", 
                    headerFilterParams:{values: sizeWidthOptions}, 
                    headerFilterFunc:"=", 
                    sorter:"number"
                },
                {
                    title:"Length (mm)", 
                    field:"length_in_mm", 
                    headerFilter:"list", 
                    headerFilterParams:{values: lengthMMOptions}, 
                    headerFilterFunc:"=", 
                    sorter:"number"
                },
                {
                    title:"Width (mm)", 
                    field:"width_in_mm", 
                    headerFilter:"list", 
                    headerFilterParams:{values: widthMMOptions}, 
                    headerFilterFunc:"=", 
                    sorter:"number"
                },
                {
                    title:"Unit", 
                    field:"unit_code", 
                    headerFilter:"list", 
                    headerFilterParams:{values: unitOptions}, 
                    headerFilterFunc:"="
                },
                {
                    title:"Active", 
                    field:"active", 
                    hozAlign:"center", 
                    formatter:"tickCross", 
                    headerFilter:"list", 
                    headerFilterParams:{values: activeOptions}, 
                    headerFilterFunc:"=", 
                    editorParams:{
                        values: {
                            true: "Active",
                            false: "Inactive"
                        }
                    }
                }
            ],

            ajaxRequestFunc: function(url, config, params){
                return new Promise(function(resolve, reject){
                    let query = new URLSearchParams();
                    query.append("page", params.page || 1);
                    query.append("page_size", params.size || 10);

                    // Store current values before making request
                    const currentValues = {};
                    if(params.filter && params.filter.length > 0){
                        params.filter.forEach(filter => {
                            if(filter.value !== undefined && filter.value !== null && filter.value !== ""){
                                query.append(filter.field, filter.value);
                                currentValues[filter.field] = filter.value;
                                console.log("Applying filter - Field:", filter.field, "Value:", filter.value);
                            }
                        });
                    }

                    // Store current values for reapplication
                    const storedValues = {...currentValues};

                    // Sorting
                    if(params.sort && params.sort.length > 0){
                        params.sort.forEach(sorter => {
                            let dir = sorter.dir === "asc" ? "" : "-";
                            query.append("ordering", dir + sorter.field);
                        });
                    }

                    // Global search
                    let globalValue = document.getElementById("globalSearch").value;
                    if(globalValue) query.append("global_search", globalValue);

                    let requestUrl = url + "?" + query.toString();
                    console.log("Making API request to:", requestUrl);

                    // Use faster timeout
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 5000);
                    
                    fetch(requestUrl, {...config, signal: controller.signal})
                        .then(response => {
                            clearTimeout(timeoutId);
                            return response.json();
                        })
                        .then(data => {
                            // Update dropdowns from the filters object (entire filtered dataset)
                            if(data.filters){
                                let filterFields = ["code","name", "size_length", "size_width", "length_in_mm", "width_in_mm", "unit_code"];

                                filterFields.forEach(col => {
                                    if(data.filters[col]){
                                        let selectOptions = {"": "All"};
                                        data.filters[col].forEach(v => {
                                            selectOptions[v] = v;
                                        });
                                        
                                        // Only update if options changed
                                        const currentValue = storedValues[col];
                                        table.updateColumnDefinition(col, {
                                            headerFilterParams: {values: selectOptions}
                                        });

                                        // Reapply previously selected value if any
                                        if (currentValue !== undefined && currentValue !== null && currentValue !== "") {
                                            setTimeout(() => {
                                                table.setHeaderFilterValue(col, currentValue);
                                                updateFilterDisplay(col, currentValue);
                                            }, 0);
                                        }
                                    }
                                });

                                // Handle active field separately
                                if(data.filters.active){
                                    const currentActiveFilter = storedValues["active"];
                                    
                                    let activeOpts = {"": "All"};
                                    data.filters.active.forEach(item => {
                                        if(item.value === true || item.value === "true") {
                                            activeOpts["true"] = item.label || "Active";
                                        }    
                                        else if(item.value === false || item.value === "false") {
                                            activeOpts["false"] = "Inactive";
                                        }    
                                    });
                                    table.updateColumnDefinition("active", {
                                        headerFilterParams: {values: activeOpts}
                                    });
                                    
                                    if (currentActiveFilter !== undefined && currentActiveFilter !== null && currentActiveFilter !== "") {
                                        setTimeout(() => {
                                            table.setHeaderFilterValue("active", currentActiveFilter);
                                            updateFilterDisplay("active", currentActiveFilter);
                                        }, 0);
                                    }
                                }
                            }

                            resolve(data);
                        })
                        .catch(error => {
                            clearTimeout(timeoutId);
                            console.error("Error fetching data:", error);
                            reject(error);
                        });
                });
            },

            ajaxResponse: function(url, params, response){
                let lastPage = Math.ceil(response.count / params.size);
                return { last_page: lastPage, data: response.results };
            }
        });

        // Add event listeners AFTER table creation
        table.on("tableBuilt", function(){
            console.log("Table built successfully");

            // SETUP REFRESH BUTTON HERE - MOVED FROM INSIDE THE CONFIG OBJECT
            setupRefreshButton();

            // Debounced filter update
            let filterTimeout;
            table.on("headerFilterChanged", function(column, value){
                clearTimeout(filterTimeout);
                filterTimeout = setTimeout(() => {
                    updateFilterDisplay(column.getField(), value);
                }, 5);
            });

            // Faster data loaded handler
            table.on("dataLoaded", function(data){
                setTimeout(() => {
                    const currentFilters = table.getHeaderFilters();
                    currentFilters.forEach(filter => {
                        if (filter.value !== undefined && filter.value !== "" && filter.value !== "All") {
                            updateFilterDisplay(filter.field, filter.value);
                        } else {
                            updateFilterDisplay(filter.field, "");
                        }
                    });
                }, 25);
            });

            // Faster initialization
            setTimeout(() => {
                const currentFilters = table.getHeaderFilters();
                currentFilters.forEach(filter => {
                    updateFilterDisplay(filter.field, filter.value);
                });
            }, 150);
        });

        table.on("rowClick",function(e,row){
            const data = row.getData();
            window.location.href = `detail/${data.code}/`;
        });

        // Global search with optimized debounce
        let searchTimeout;
        document.getElementById("globalSearch").addEventListener("input", function(){
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => table.setData(), 400);
        });

    })
    .catch(error => console.error("Failed to load filter options:", error));
</script>
{% endblock %}


